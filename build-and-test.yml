pool:
  vmImage: 'windows-2019'
  
trigger: none

# Configure this to run for both Debug and Release configurations
strategy:
  maxParallel: 4
  matrix:
    debug x86:
      BuildConfiguration: Debug
      BuildPlatform: x86
    release x86:
      BuildConfiguration: Release 
      BuildPlatform: x86
    debug x64:
      BuildConfiguration: Debug
      BuildPlatform: x64
    release x64:
      BuildConfiguration: Release  
      BuildPlatform: x64      

variables: 
  - group: InternalKeys
  - name: RestoreBuildProjects
    value: '*.sln'
  - name: TestProjects
    value: '**/*[Tt]ests/**/*.csproj'

steps:
# Get the data files that are required for device detection automated system tests.
- powershell: |
   git lfs install
   ls
   git config --global --add filter.lfs.required true
   git config --global --add filter.lfs.smudge "git-lfs smudge -- %f"
   git config --global --add filter.lfs.process "git-lfs filter-process"
   git config --global --add filter.lfs.clean "git-lfs clean -- %f"
  displayName: 'Configure git lfs'

- checkout: self
  lfs: true
  submodules: recursive

# Install NuGet and restore packages
- task: NuGetToolInstaller@0
  displayName: 'Use NuGet 5.5.1'
  inputs:
    versionSpec: 5.5.1

- task: NuGetCommand@2
  displayName: 'NuGet restore'
  inputs:
    command: 'restore'
    restoreSolution: '$(RestoreBuildProjects)'
    feedsToUse: 'select'
    vstsFeed: 'd2431f86-c1e6-4d8b-8d27-311cf3614847'
- task: UseDotNet@2
  displayName: "Configure dotnet"
  inputs:
    version: 3.1.x
    performMultiLevelLookup: true
    packageType: sdk
# Build
- task: VSBuild@1
  displayName: 'Build solutions'
  inputs:
    solution: '$(RestoreBuildProjects)'
    vsVersion: '16.0'
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    clean: true
    msbuildArchitecture: '$(BuildPlatform)'    
   
- task: VisualStudioTestPlatformInstaller@1
  displayName: 'Visual Studio Test Platform Installer'
  inputs:
    versionSelector: latestStable
    
- task: VSTest@2
  displayName: 'VsTest - testAssemblies - dotnet framework'
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\$(BuildPlatform)\**\net4*\*Tests*.dll
      !**\*TestAdapter*.dll
      !**\*TestFramework*.dll
      !**\obj\**
    searchFolder: '$(System.DefaultWorkingDirectory)'
    otherConsoleOptions: '/Framework:net462 /Platform:$(BuildPlatform) /logger:console;verbosity="normal"'
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    diagnosticsEnabled: true
    testRunTitle: 'framework-$(BuildConfiguration)-$(BuildPlatform)'
    vsTestVersion: toolsInstaller
    # Disabled these options for now as it is not finding the framework tests correctly on the build agent.
    #minimumExpectedTests: '1'
    #failOnMinTestsNotRun: true

- task: VSTest@2
  displayName: 'VsTest - testAssemblies - dotnet core'
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\$(BuildPlatform)\**\netcoreapp*\*Tests*.dll
      !**\*TestAdapter*.dll
      !**\*TestFramework*.dll
      !**\obj\**
      !**\performance_tests.dll
    searchFolder: '$(System.DefaultWorkingDirectory)'
    vsTestVersion: 'toolsInstaller'
    codeCoverageEnabled: true
    otherConsoleOptions: '/Framework:netcoreapp3.1 /Platform:$(BuildPlatform) /logger:console;verbosity="normal"'
    testRunTitle: 'core-$(BuildConfiguration)-$(BuildPlatform)'
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    failOnMinTestsNotRun: true
    diagnosticsEnabled: true
    collectDumpOn: 'always'
  condition: succeededOrFailed()
    
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      cd performance-tests/
      mkdir build
      cd build
      cmake ..
      cmake --build .
      cd ..

- task: PowerShell@2
  inputs:
    filePath: '$(System.DefaultWorkingDirectory)/performance-tests/build/runPerf.ps1'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
    arguments: '-c $(BuildConfiguration)'
  condition: eq(variables['BuildPlatform'], 'x64')

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'performance-tests/build'
    ArtifactName: 'perfout-$(BuildConfiguration)-$(BuildPlatform)'
    publishLocation: 'Container'
  displayName: 'Publish Performance Artifacts'
  condition: and(succeededOrFailed(), eq(variables['BuildPlatform'], 'x64'))

