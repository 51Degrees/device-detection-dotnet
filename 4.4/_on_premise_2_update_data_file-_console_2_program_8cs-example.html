<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>51Degrees Device Detection .NET: OnPremise/UpdateDataFile-Console/Program.cs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="examplegrabber.js"></script>
<script type="text/javascript" src="testedversionsgrabber.js"></script>
<script type="text/javascript" src="search51.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="docs-main.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="l-docs-index p-doxygen">
<div class="l-index__content">
<!--div id="top"--><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" class="g-header g-header--docs">
  <h1 class="c-brand">
  <a id="projectlogo" href="../../documentation/4.4/index.html" class="c-brand__link"><img class="c-brand__image" alt="Logo" src="logo-51Degrees-Docs.png" style="width:172px;"/></a>
  <span class="c-tagline">51Degrees Device Detection .NET
   &#160;<span id="projectnumber">4.4</span>
  </span>
  </h1>
  <div id="projectalign" style="padding-left: 0.5em;">
   <div id="projectbrief">Device detection services for 51Degrees Pipeline</div>
  </div>
  <div id="main-nav"></div>
  <section class="g-search">
    <div class="c-search is-openable" id="searchOpenable">
    <form class="c-search__form">
      <div class="b-form-group b-form-group--with-icon">
        <label for="inputSearch" class="b-text--hidden">Search</label>
        <img src="icon-search.svg" class="b-icon" alt="Search" />
        <input type="text" class="c-search__input" id="inputSearch" onkeyup="javascript:onSearch(this,event.keyCode)" placeholder="Search" aria-label="Search">
      </div>
    </form>
    <div class="c-search__content" id="searchContent">
    </div>
  </div> 
  </section>
</div>
<!-- end header part -->
<main class="g-main">
<!-- Generated by Doxygen 1.8.15 -->
<!-- top -->
	<div class="g-docs__sidenav">																														         <nav id="nav-tree-contents" class="c-sidenav">																														     <h4 class="c-sidenav__heading">Documentation</h4>																									         <div id="nav-sync" class="sync"></div>
  <ul class="c-sidenav__list">																														     </ul>																																				   </nav>    </div><script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_on_premise_2_update_data_file-_console_2_program_8cs-example.html','');});
/* @license-end */
</script>
<div id="doc-content" class="g-docs__content">
<div class="g-docs__header">
<h2 class="g-docs__page-title">OnPremise/UpdateDataFile-Console/Program.cs</h2></div><!--header-->
<div class="g-docs__inner">
<div class="g-docs__primary" id="primary">
<p>This example illustrates various parameters that can be adjusted when using the on-premise device detection engine, and controls when a new data file is sought and when it is loaded by the device detection software.Three main aspects are demonstrated:</p><ul>
<li>Update on Start-Up</li>
<li>Filesystem Watcher</li>
<li>Daily auto-update</li>
</ul>
<h1 class="g-docs__section-heading">License Key</h1>
<p>In order to test this example you will need a 51Degrees Enterprise license which can be purchased from our <a href="https://51degrees.com/pricing">pricing page</a>.</p>
<h1 class="g-docs__section-heading">Data Files</h1>
<p>You can find out more about data files, licenses etc. at our <a href="https://51degrees.com/resources/faqs">FAQ page</a></p>
<h2>Enterprise Data File</h2>
<p>Enterprise (fully-featured) data files are typically released by 51Degrees five days a week (Mon-Fri) and on-premise deployments can fetch and download those files automatically. Equally, customers may choose to download the files themselves and move them into place to be detected by the 51Degrees filesystem watcher.</p>
<h3>Manual Download</h3>
<p>If you prefer to download files yourself, you may do so here: </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">https:<span class="c-code__comment">//distributor.51degrees.com/api/v2/download?LicenseKeys=&lt;your_license_key&gt;&amp;Type=27&amp;Download=True&amp;Product=22</span></div></div><h2>Lite Data File</h2>
<p>Lite data files (free-to-use, limited capabilities, no license key required) are created roughly once a month and cannot be updated using auto-update, they may be downloaded from <a href="https://github.com/51Degrees/device-detection-data">Github</a> and are included with source distributions of this software.</p>
<h1 class="g-docs__section-heading">Update on Start-Up</h1>
<p>You can configure the pipeline builder to download an Enterprise data file on start-up.</p>
<h2>Pre-Requisites</h2>
<ul>
<li>a license key</li>
<li>a file location for the download<ul>
<li>this may be an existing file - which will be overwritten</li>
<li>or if it does not exist must end in ".hash" and must be in an existing directory</li>
</ul>
</li>
</ul>
<h2>Configuration</h2>
<ul>
<li>the pipeline must be configured to use a temp file <div class="c-code__block c-code__block--outline"><div class="c-code__line">.UseOnPremise(dataFilename, <span class="c-code__keyword">true</span>)</div></div></li>
<li>update on start-up must be specified, which will cause pipeline creation to block until a file is downloaded <div class="c-code__block c-code__block--outline"><div class="c-code__line">.setDataUpdateOnStartup(<span class="c-code__keyword">true</span>)</div></div></li>
</ul>
<h1 class="g-docs__section-heading">File System Watcher</h1>
<p>You can configure the pipeline builder to watch for changes to the currently loaded device detection data file, and to replace the file currently in use with the new one. This is useful, for example, if you wish to download and update the device detection file "manually" - i.e. you would download it then drop it into place with the same path as the currently loaded file.</p>
<h2>Pre-Requisites</h2>
<ul>
<li>a license key</li>
<li>the file location of the existing file</li>
</ul>
<h2>Configuration</h2>
<ul>
<li>the pipeline must be configured to use a temp file <div class="c-code__block c-code__block--outline"><div class="c-code__line">.UseOnPremise(dataFilename, <span class="c-code__keyword">true</span>)</div></div></li>
</ul>
<h2>Daily auto-update</h2>
<p>Enterprise data files are usually created four times a week. Each data file contains a date for when the next data file is expected. You can configure the pipeline so that it starts looking for a newer data file after that time, by connecting to the 51Degrees distributor to see if an update is available. If one is, then it is downloaded and will replace the existing device detection file, which is currently in use.</p>
<h2>Pre-Requisites</h2>
<ul>
<li>a license key</li>
<li>the file location of the existing file</li>
</ul>
<h2>Configuration</h2>
<ul>
<li>the pipeline must be configured with a license key and the 'use temp file' flag must be set. <div class="c-code__block c-code__block--outline"><div class="c-code__line">.UseOnPremise(dataFile, licenseKey, <span class="c-code__keyword">true</span>)</div></div></li>
<li>Set the frequency in seconds that the pipeline should check for updates to data files. A recommended polling interval in a production environment is around 30 minutes. <div class="c-code__block c-code__block--outline"><div class="c-code__line">.SetUpdatePollingInterval(30*60)</div></div></li>
<li>Set the max amount of time in seconds that should be added to the polling interval. This is useful in data-center applications where multiple instances may be polling for updates at the same time. A recommended amount in production environments is 600 seconds. <div class="c-code__block c-code__block--outline"><div class="c-code__line">.SetUpdateRandomisationMax(10*60)</div></div></li>
</ul>
<h1 class="g-docs__section-heading">Location</h1>
<p>This example is available in full on <a href="https://github.com/51Degrees/device-detection-dotnet-examples/blob/master/Examples/OnPremise/UpdateDataFile-Console/Program.cs">GitHub</a>. </p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line"><span class="c-code__comment">/* *********************************************************************</span></div><div class="c-code__line"><span class="c-code__comment"> * This Original Work is copyright of 51 Degrees Mobile Experts Limited.</span></div><div class="c-code__line"><span class="c-code__comment"> * Copyright 2023 51 Degrees Mobile Experts Limited, Davidson House,</span></div><div class="c-code__line"><span class="c-code__comment"> * Forbury Square, Reading, Berkshire, United Kingdom RG1 3EU.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * This Original Work is licensed under the European Union Public Licence</span></div><div class="c-code__line"><span class="c-code__comment"> * (EUPL) v.1.2 and is subject to its terms as set out below.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * If a copy of the EUPL was not distributed with this file, You can obtain</span></div><div class="c-code__line"><span class="c-code__comment"> * one at https://opensource.org/licenses/EUPL-1.2.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * The &#39;Compatible Licences&#39; set out in the Appendix to the EUPL (as may be</span></div><div class="c-code__line"><span class="c-code__comment"> * amended by the European Commission) shall be deemed incompatible for</span></div><div class="c-code__line"><span class="c-code__comment"> * the purposes of the Work and the provisions of the compatibility</span></div><div class="c-code__line"><span class="c-code__comment"> * clause in Article 5 of the EUPL shall not apply.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * If using the Work as, or as part of, a network application, by</span></div><div class="c-code__line"><span class="c-code__comment"> * including the attribution notice(s) required under Article 5 of the EUPL</span></div><div class="c-code__line"><span class="c-code__comment"> * in the end user terms of the application under an appropriate heading,</span></div><div class="c-code__line"><span class="c-code__comment"> * such notice(s) shall fulfill the requirements of that article.</span></div><div class="c-code__line"><span class="c-code__comment"> * ********************************************************************* */</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">using</span> <a class="code" href="namespace_fifty_one.html">FiftyOne</a>.<a class="code" href="namespace_fifty_one_1_1_device_detection.html">DeviceDetection</a>.Hash.Engine.OnPremise.FlowElements;</div><div class="c-code__line"><span class="c-code__keyword">using</span> <a class="code" href="namespace_fifty_one.html">FiftyOne</a>.Pipeline.Engines.Services;</div><div class="c-code__line"><span class="c-code__keyword">using</span> Microsoft.Extensions.DependencyInjection;</div><div class="c-code__line"><span class="c-code__keyword">using</span> Microsoft.Extensions.Logging;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.IO;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Net.Http;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">namespace </span><a class="code" href="namespace_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file.html">FiftyOne.DeviceDetection.Examples.OnPremise.UpdateDataFile</a></div><div class="c-code__line">{</div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>Program</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>Example : ExampleBase</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keyword">public</span> DeviceDetectionPipelineBuilder <a name="a0"></a><a class="code" href="class_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file_1_1_program_1_1_example.html#a4d47068929eed40034dc8f0fe608beed">PipelineBuilder</a> { <span class="c-code__keyword">get</span>; <span class="c-code__keyword">private</span> <span class="c-code__keyword">set</span>; }</div><div class="c-code__line">            <span class="c-code__keyword">public</span> DeviceDetectionHashEngineBuilder <a name="a1"></a><a class="code" href="class_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file_1_1_program_1_1_example.html#a4bc9cd9ff7edb58e0858f5a43be79a82">EngineBuilder</a> { <span class="c-code__keyword">get</span>; <span class="c-code__keyword">private</span> <span class="c-code__keyword">set</span>; }</div><div class="c-code__line">            <span class="c-code__keyword">public</span> ILogger&lt;Example&gt; Logger { <span class="c-code__keyword">get</span>; <span class="c-code__keyword">private</span> <span class="c-code__keyword">set</span>; }</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keyword">private</span> TimeSpan _updateTimeout = <span class="c-code__keyword">new</span> TimeSpan(0, 0, 20);</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keyword">private</span> CompletionListener CompletionListener;</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keyword">public</span> <a name="a2"></a><a class="code" href="class_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file_1_1_program_1_1_example.html#a0181f34c8792d54852cd95efebe3a35d">Example</a>(DeviceDetectionPipelineBuilder pipelineBuilder, </div><div class="c-code__line">                DeviceDetectionHashEngineBuilder engineBuilder,</div><div class="c-code__line">                CompletionListener completionListener,</div><div class="c-code__line">                ILogger&lt;Example&gt; logger)</div><div class="c-code__line">            {</div><div class="c-code__line">                <a class="code" href="class_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file_1_1_program_1_1_example.html#a4d47068929eed40034dc8f0fe608beed">PipelineBuilder</a> = pipelineBuilder;</div><div class="c-code__line">                <a class="code" href="class_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file_1_1_program_1_1_example.html#a4bc9cd9ff7edb58e0858f5a43be79a82">EngineBuilder</a> = engineBuilder;</div><div class="c-code__line">                CompletionListener = completionListener;</div><div class="c-code__line">                Logger = logger;</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">void</span> <a name="a3"></a><a class="code" href="class_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file_1_1_program_1_1_example.html#a47ae2930aa9226fd8c0a81a435619363">Run</a>(<span class="c-code__keywordtype">string</span> dataFile, <span class="c-code__keywordtype">string</span> licenseKey, <span class="c-code__keywordtype">bool</span> interactive)</div><div class="c-code__line">            {</div><div class="c-code__line">                Logger.LogInformation(<span class="c-code__stringliteral">&quot;Starting example&quot;</span>);</div><div class="c-code__line"></div><div class="c-code__line">                licenseKey = CheckLicenseKey(licenseKey, Logger);</div><div class="c-code__line">                dataFile = CheckDataFile(dataFile, Logger);</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__keywordtype">string</span> copyDataFile = dataFile + <span class="c-code__stringliteral">&quot;.bak&quot;</span>;</div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (File.Exists(dataFile))</div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__comment">// Let&#39;s check this file out</span></div><div class="c-code__line">                    var metadata = ExampleUtils.GetDataFileInfo(dataFile, <a class="code" href="class_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file_1_1_program_1_1_example.html#a4bc9cd9ff7edb58e0858f5a43be79a82">EngineBuilder</a>);</div><div class="c-code__line">                    <span class="c-code__comment">// and output the results</span></div><div class="c-code__line">                    ExampleUtils.LogDataFileInfo(metadata, Logger);</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (metadata.Tier.Equals(<span class="c-code__stringliteral">&quot;Lite&quot;</span>))</div><div class="c-code__line">                    {</div><div class="c-code__line">                        Logger.LogError(<span class="c-code__stringliteral">&quot;Will not download an &#39;Enterprise&#39; data file over the top of &quot;</span> +</div><div class="c-code__line">                                <span class="c-code__stringliteral">&quot;a &#39;Lite&#39; data file, please supply another location.&quot;</span>);</div><div class="c-code__line">                        <span class="c-code__keywordflow">throw</span> <span class="c-code__keyword">new</span> ArgumentException(<span class="c-code__stringliteral">&quot;File supplied has wrong data tier&quot;</span>);</div><div class="c-code__line">                    }</div><div class="c-code__line">                    Logger.LogInformation(<span class="c-code__stringliteral">&quot;Existing data file will be replaced with downloaded data file&quot;</span>);</div><div class="c-code__line">                    Logger.LogInformation(<span class="c-code__stringliteral">&quot;Existing data file will be copied to {}&quot;</span>, copyDataFile);</div><div class="c-code__line">                }</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__comment">// do we really want to do this</span></div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (interactive)</div><div class="c-code__line">                {</div><div class="c-code__line">                    Logger.LogWarning(<span class="c-code__stringliteral">&quot;Please note - this example will use available downloads &quot;</span> +</div><div class="c-code__line">                            <span class="c-code__stringliteral">&quot;in your licensed allocation.&quot;</span>);</div><div class="c-code__line">                    Logger.LogWarning(<span class="c-code__stringliteral">&quot;Do you wish to continue with this example (y)? &quot;</span>);</div><div class="c-code__line">                    var key = Console.ReadKey();</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (key.Key != ConsoleKey.Y)</div><div class="c-code__line">                    {</div><div class="c-code__line">                        Logger.LogInformation(<span class="c-code__stringliteral">&quot;Stopping example without download&quot;</span>);</div><div class="c-code__line">                        <span class="c-code__keywordflow">return</span>;</div><div class="c-code__line">                    }</div><div class="c-code__line">                }</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (File.Exists(dataFile))</div><div class="c-code__line">                {</div><div class="c-code__line">                    File.Copy(dataFile, copyDataFile, <span class="c-code__keyword">true</span>);</div><div class="c-code__line">                    Logger.LogInformation(<span class="c-code__stringliteral">&quot;Existing data file copied to {}&quot;</span>, copyDataFile);</div><div class="c-code__line">                }</div><div class="c-code__line"></div><div class="c-code__line">                Logger.LogInformation(<span class="c-code__stringliteral">&quot;Creating pipeline and initiating update on start-up - &quot;</span> +</div><div class="c-code__line">                    <span class="c-code__stringliteral">&quot;please wait for that to complete&quot;</span>);</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__comment">// Build the device detection pipeline  and pass in the desired settings to configure</span></div><div class="c-code__line">                <span class="c-code__comment">// automatic updates.</span></div><div class="c-code__line">                <span class="c-code__keywordflow">try</span></div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__keyword">using</span> (var pipeline = <a class="code" href="class_fifty_one_1_1_device_detection_1_1_examples_1_1_on_premise_1_1_update_data_file_1_1_program_1_1_example.html#a4d47068929eed40034dc8f0fe608beed">PipelineBuilder</a></div><div class="c-code__line">                        <span class="c-code__comment">// specify the filename for the data file. When using update on start-up</span></div><div class="c-code__line">                        <span class="c-code__comment">// the file need not exist, but the directory it is in must exist.</span></div><div class="c-code__line">                        <span class="c-code__comment">// Any file that is present is overwritten. Because the file will be</span></div><div class="c-code__line">                        <span class="c-code__comment">// overwritten, the pipeline must be configured to copy the supplied</span></div><div class="c-code__line">                        <span class="c-code__comment">// file to a temporary file (createTempDataCopy parameter == true).</span></div><div class="c-code__line">                        <span class="c-code__comment">//</span></div><div class="c-code__line">                        <span class="c-code__comment">// For automatic updates to work you will also need to provide a license key.</span></div><div class="c-code__line">                        <span class="c-code__comment">// A license key can be obtained with a subscription from https://51degrees.com/pricing</span></div><div class="c-code__line">                        .UseOnPremise(dataFile, licenseKey, <span class="c-code__keyword">true</span>)</div><div class="c-code__line">                        <span class="c-code__comment">// Enable update on startup, the auto update system</span></div><div class="c-code__line">                        <span class="c-code__comment">// will be used to check for an update before the</span></div><div class="c-code__line">                        <span class="c-code__comment">// device detection engine is created. This will block</span></div><div class="c-code__line">                        <span class="c-code__comment">// creation of the pipeline until the data file is downloaded.</span></div><div class="c-code__line">                        .SetDataUpdateOnStartUp(<span class="c-code__keyword">true</span>)</div><div class="c-code__line">                        <span class="c-code__comment">// Enable automatic updates once the pipeline has started.</span></div><div class="c-code__line">                        .SetAutoUpdate(<span class="c-code__keyword">true</span>)</div><div class="c-code__line">                        <span class="c-code__comment">// Watch the data file on disk and refresh the engine</span></div><div class="c-code__line">                        <span class="c-code__comment">// as soon as that file is updated.</span></div><div class="c-code__line">                        .SetDataFileSystemWatcher(<span class="c-code__keyword">true</span>)</div><div class="c-code__line">                        <span class="c-code__comment">// For the purposes of this example we are setting the time</span></div><div class="c-code__line">                        <span class="c-code__comment">// between checks to see if the file has changed to 1 second.</span></div><div class="c-code__line">                        <span class="c-code__comment">// By default this is 30 mins.</span></div><div class="c-code__line">                        .SetUpdatePollingInterval(1)</div><div class="c-code__line">                        <span class="c-code__comment">// Build the pipeline.</span></div><div class="c-code__line">                        .Build())</div><div class="c-code__line">                    {</div><div class="c-code__line">                        <span class="c-code__comment">// thread blocks till update checking is complete - or if there is an</span></div><div class="c-code__line">                        <span class="c-code__comment">// exception we don&#39;t get this far</span></div><div class="c-code__line">                        Logger.LogInformation(<span class="c-code__stringliteral">&quot;Update on start-up complete - status - &quot;</span> +</div><div class="c-code__line">                            CompletionListener.Result.Status);</div><div class="c-code__line"></div><div class="c-code__line">                        <span class="c-code__keywordflow">if</span> (CompletionListener.Result.Status == AutoUpdateStatus.AUTO_UPDATE_SUCCESS ||</div><div class="c-code__line">                            CompletionListener.Result.Status == AutoUpdateStatus.AUTO_UPDATE_NOT_NEEDED)</div><div class="c-code__line">                        {</div><div class="c-code__line">                            Logger.LogInformation(<span class="c-code__stringliteral">&quot;Modifying downloaded file to trigger reload ... &quot;</span> +</div><div class="c-code__line">                                                  <span class="c-code__stringliteral">&quot;please wait for that to complete&quot;</span>);</div><div class="c-code__line">                            <span class="c-code__comment">// wait for the dataUpdateService to notify us that it has updated</span></div><div class="c-code__line">                            CompletionListener.Reset();</div><div class="c-code__line"></div><div class="c-code__line">                            <span class="c-code__comment">// it&#39;s the same file but changing the file metadata will trigger reload,</span></div><div class="c-code__line">                            <span class="c-code__comment">// demonstrating that if you download a new file and replace the</span></div><div class="c-code__line">                            <span class="c-code__comment">// existing one, then it will be loaded</span></div><div class="c-code__line">                            <span class="c-code__keywordflow">try</span></div><div class="c-code__line">                            {</div><div class="c-code__line">                                <span class="c-code__keyword">new</span> FileInfo(dataFile).LastWriteTimeUtc = DateTime.UtcNow;</div><div class="c-code__line">                            }</div><div class="c-code__line">                            <span class="c-code__keywordflow">catch</span> (IOException)</div><div class="c-code__line">                            {</div><div class="c-code__line">                                <span class="c-code__keywordflow">throw</span> <span class="c-code__keyword">new</span> InvalidOperationException(<span class="c-code__stringliteral">&quot;Could not modify file time, &quot;</span> +</div><div class="c-code__line">                                                                    <span class="c-code__stringliteral">&quot;abandoning example&quot;</span>);</div><div class="c-code__line">                            }</div><div class="c-code__line"></div><div class="c-code__line">                            <span class="c-code__keywordflow">try</span></div><div class="c-code__line">                            {</div><div class="c-code__line">                                CompletionListener.WaitForComplete(_updateTimeout);</div><div class="c-code__line">                                Logger.LogInformation($<span class="c-code__stringliteral">&quot;Update on file modification complete, &quot;</span> +</div><div class="c-code__line">                                                      $<span class="c-code__stringliteral">&quot;status: {CompletionListener.Result.Status}&quot;</span>);</div><div class="c-code__line">                            }</div><div class="c-code__line">                            <span class="c-code__keywordflow">catch</span> (TimeoutException)</div><div class="c-code__line">                            {</div><div class="c-code__line">                                Logger.LogError(<span class="c-code__stringliteral">&quot;Timeout waiting for engine to refresh data.&quot;</span>);</div><div class="c-code__line">                            }</div><div class="c-code__line">                        }</div><div class="c-code__line">                        <span class="c-code__keywordflow">else</span></div><div class="c-code__line">                        {</div><div class="c-code__line">                            Logger.LogError(<span class="c-code__stringliteral">&quot;Auto update was not successful, abandoning example&quot;</span>);</div><div class="c-code__line">                            <span class="c-code__keywordflow">throw</span> <span class="c-code__keyword">new</span> InvalidOperationException(<span class="c-code__stringliteral">&quot;Auto update failed: &quot;</span> +</div><div class="c-code__line">                                                                CompletionListener.Result.Status);</div><div class="c-code__line">                        }</div><div class="c-code__line"></div><div class="c-code__line">                        Logger.LogInformation(<span class="c-code__stringliteral">&quot;Finished Example&quot;</span>);</div><div class="c-code__line">                    }</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__keywordflow">catch</span> (Pipeline.Engines.Exceptions.DataUpdateException ex)</div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (ex.Status != AutoUpdateStatus.AUTO_UPDATE_ERR_429_TOO_MANY_ATTEMPTS)</div><div class="c-code__line">                    {</div><div class="c-code__line">                        <span class="c-code__keywordflow">throw</span>;</div><div class="c-code__line">                    }</div><div class="c-code__line">                    Logger.LogWarning(<span class="c-code__stringliteral">&quot;Auto update failed with 429 status code, &quot;</span> +</div><div class="c-code__line">                                      <span class="c-code__stringliteral">&quot;abandoning example&quot;</span>);</div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">string</span> CheckLicenseKey(<span class="c-code__keywordtype">string</span> licenseKey, ILogger logger)</div><div class="c-code__line">            {</div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (licenseKey == <span class="c-code__keyword">null</span>)</div><div class="c-code__line">                {</div><div class="c-code__line">                    licenseKey = Environment.GetEnvironmentVariable(Constants.LICENSE_KEY_ENV_VAR);</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">string</span> keySubmissionPaths = <span class="c-code__stringliteral">&quot;as the second command line argument to this program, or as &quot;</span> +</div><div class="c-code__line">                        $<span class="c-code__stringliteral">&quot;an environment variable named &#39;{Constants.LICENSE_KEY_ENV_VAR}&#39;&quot;</span>;</div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (licenseKey == <span class="c-code__keyword">null</span>)</div><div class="c-code__line">                {</div><div class="c-code__line">                    logger.LogError(<span class="c-code__stringliteral">&quot;In order to test this example you will need a 51Degrees &quot;</span> +</div><div class="c-code__line">                        <span class="c-code__stringliteral">&quot;Enterprise license which can be obtained on a trial basis or purchased &quot;</span> +</div><div class="c-code__line">                        <span class="c-code__stringliteral">&quot;from our pricing page https://51degrees.com/pricing. You must supply the &quot;</span> +</div><div class="c-code__line">                        <span class="c-code__stringliteral">&quot;license key &quot;</span> + keySubmissionPaths);</div><div class="c-code__line">                    <span class="c-code__keywordflow">throw</span> <span class="c-code__keyword">new</span> ArgumentException(<span class="c-code__stringliteral">&quot;No license key available&quot;</span>, nameof(licenseKey));</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (ExampleUtils.IsInvalidKey(licenseKey))</div><div class="c-code__line">                {</div><div class="c-code__line">                    logger.LogWarning(<span class="c-code__stringliteral">&quot;The license key supplied (&quot;</span> + keySubmissionPaths + <span class="c-code__stringliteral">&quot;) is probably invalid.&quot;</span>);</div><div class="c-code__line">                }</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__keywordflow">return</span> licenseKey;</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">string</span> CheckDataFile(<span class="c-code__keywordtype">string</span> dataFile, ILogger logger)</div><div class="c-code__line">            {</div><div class="c-code__line">                <span class="c-code__comment">// No filename specified use the default</span></div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (dataFile == <span class="c-code__keyword">null</span>)</div><div class="c-code__line">                {</div><div class="c-code__line">                    dataFile = Constants.ENTERPRISE_HASH_DATA_FILE_NAME;</div><div class="c-code__line">                    logger.LogWarning($<span class="c-code__stringliteral">&quot;No filename specified. Using default &#39;{dataFile}&#39;&quot;</span>);</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__comment">// Work out where the data file is if we don&#39;t have an absolute path.</span></div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (dataFile != <span class="c-code__keyword">null</span> &amp;&amp; Path.IsPathRooted(dataFile) == <span class="c-code__keyword">false</span>)</div><div class="c-code__line">                {</div><div class="c-code__line">                    var fullPath = ExampleUtils.FindFile(dataFile);</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (fullPath == <span class="c-code__keyword">null</span>)</div><div class="c-code__line">                    {</div><div class="c-code__line">                        dataFile = Path.Combine(Directory.GetCurrentDirectory(), dataFile);</div><div class="c-code__line">                        logger.LogWarning($<span class="c-code__stringliteral">&quot;File &#39;{dataFile}&#39; not found, a file will be &quot;</span> +</div><div class="c-code__line">                            $<span class="c-code__stringliteral">&quot;downloaded to that location on start-up&quot;</span>);</div><div class="c-code__line">                    }</div><div class="c-code__line">                    <span class="c-code__keywordflow">else</span></div><div class="c-code__line">                    {</div><div class="c-code__line">                        dataFile = fullPath;</div><div class="c-code__line">                    }</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__comment">// If we do have an absolute path but the file does not exist, then log a warning.</span></div><div class="c-code__line">                <span class="c-code__keywordflow">else</span> <span class="c-code__keywordflow">if</span> (dataFile != <span class="c-code__keyword">null</span> &amp;&amp; File.Exists(dataFile) == <span class="c-code__keyword">false</span>)</div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (<span class="c-code__keyword">new</span> FileInfo(dataFile).Directory.Exists == <span class="c-code__keyword">false</span>)</div><div class="c-code__line">                    {</div><div class="c-code__line">                        logger.LogError(<span class="c-code__stringliteral">&quot;The directory must exist when specifying a &quot;</span> +</div><div class="c-code__line">                            <span class="c-code__stringliteral">&quot;location for a new file to be downloaded. Path specified was &quot;</span> +</div><div class="c-code__line">                            $<span class="c-code__stringliteral">&quot;&#39;{dataFile}&#39;&quot;</span>);</div><div class="c-code__line">                        <span class="c-code__keywordflow">throw</span> <span class="c-code__keyword">new</span> ArgumentException(<span class="c-code__stringliteral">&quot;Directory for new file must exist&quot;</span>,</div><div class="c-code__line">                            nameof(dataFile));</div><div class="c-code__line">                    }</div><div class="c-code__line">                    <span class="c-code__keywordflow">else</span></div><div class="c-code__line">                    {</div><div class="c-code__line">                        logger.LogWarning($<span class="c-code__stringliteral">&quot;File &#39;{dataFile}&#39; not found, a file will be &quot;</span> +</div><div class="c-code__line">                            $<span class="c-code__stringliteral">&quot;downloaded to that location on start-up&quot;</span>);</div><div class="c-code__line">                    }</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__keywordflow">return</span> dataFile;</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> Main(<span class="c-code__keywordtype">string</span>[] args)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__comment">// Use the supplied path for the data file or find the lite file that is included</span></div><div class="c-code__line">            <span class="c-code__comment">// in the repository.</span></div><div class="c-code__line">            var dataFile = args.Length &gt; 0 ? args[0] : <span class="c-code__keyword">null</span>;</div><div class="c-code__line">            var licenseKey = args.Length &gt; 1 ? args[1] : <span class="c-code__keyword">null</span>;</div><div class="c-code__line"></div><div class="c-code__line">            Initialize(dataFile, licenseKey, <span class="c-code__keyword">true</span>);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> Initialize(</div><div class="c-code__line">            <span class="c-code__keywordtype">string</span> dataFile, <span class="c-code__keywordtype">string</span> licenseKey, <span class="c-code__keywordtype">bool</span> interactive)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__comment">// Initialize a service collection, which will be used to create the services</span></div><div class="c-code__line">            <span class="c-code__comment">// required by the Pipeline and manage their lifetimes.</span></div><div class="c-code__line">            <span class="c-code__keyword">using</span> (var serviceProvider = <span class="c-code__keyword">new</span> ServiceCollection()</div><div class="c-code__line">                <span class="c-code__comment">// Make sure we&#39;re logging to the console.</span></div><div class="c-code__line">                .AddLogging(l =&gt; l</div><div class="c-code__line">                    .AddConsole()</div><div class="c-code__line">                    <span class="c-code__comment">// Only display messages @ warning or above.</span></div><div class="c-code__line">                    <span class="c-code__comment">// Or info and above if the come from this example.</span></div><div class="c-code__line">                    <span class="c-code__comment">// This filters out some messages from the Pipeline that would otherwise </span></div><div class="c-code__line">                    <span class="c-code__comment">// make this example harder to follow.</span></div><div class="c-code__line">                    .AddFilter((c, l) =&gt; </div><div class="c-code__line">                    {</div><div class="c-code__line">                        <span class="c-code__keywordflow">return</span> l &gt;= LogLevel.Warning ||</div><div class="c-code__line">                            (c.StartsWith(typeof(Program).FullName) &amp;&amp; l &gt;= LogLevel.Information);</div><div class="c-code__line">                    }))</div><div class="c-code__line">                <span class="c-code__comment">// Add an HttpClient instance. This is used for making requests to the</span></div><div class="c-code__line">                <span class="c-code__comment">// data update end point.</span></div><div class="c-code__line">                .AddSingleton&lt;HttpClient&gt;()</div><div class="c-code__line">                <span class="c-code__comment">// We want to use the standard data update service</span></div><div class="c-code__line">                .AddSingleton&lt;IDataUpdateService, DataUpdateService&gt;()</div><div class="c-code__line">                <span class="c-code__comment">// Add the builders we&#39;re going to need.</span></div><div class="c-code__line">                .AddTransient&lt;DeviceDetectionPipelineBuilder&gt;()</div><div class="c-code__line">                .AddTransient&lt;DeviceDetectionHashEngineBuilder&gt;()</div><div class="c-code__line">                <span class="c-code__comment">// Add example classes.</span></div><div class="c-code__line">                .AddSingleton&lt;Example&gt;()</div><div class="c-code__line">                .AddSingleton&lt;CompletionListener&gt;()</div><div class="c-code__line">                .BuildServiceProvider())</div><div class="c-code__line">            {</div><div class="c-code__line">                var example = serviceProvider.GetRequiredService&lt;Example&gt;();</div><div class="c-code__line">                example.Run(dataFile, licenseKey, interactive);</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line">}</div></div> </div><!-- primary -->
</div><!-- inner-->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<section id="nav-path" class="g-footer g-footer--docs"><!-- id is needed for treeview function! -->
    <p class="g-footer__copyright">Generated by
    <a href="http://www.doxygen.org/index.html">
    <b>doxygen</b></a> 1.8.15
  </p>
</section>
</div>
</main>
</div>
</body>
</html>
